<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Timetable Viewer</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 20px; }
		h1 { margin-bottom: 8px; }
		.controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
		select, button, input { padding: 6px 10px; }
		.grid { border-collapse: collapse; width: 100%; }
		.grid th, .grid td { border: 1px solid #ddd; padding: 8px; text-align: left; }
		.grid th { background: #f0f3f7; }
		.section { margin-top: 24px; }
		.small { color: #666; font-size: 12px; }
	</style>
</head>
<body>
	<h1>Timetable Viewer</h1>
    <div class="controls">
        <button id="generate">Generate</button>
        <input id="classId" placeholder="Class ID (e.g., Grade10)" />
        <button id="showStudent">Show Student Table</button>
        <input id="teacherId" placeholder="Teacher ID (e.g., T1)" />
        <button id="showTeacher">Show Teacher Table</button>
    </div>

    <div class="section">
        <h3>Student Timetable</h3>
        <div id="studentGrid"></div>
    </div>

    <div class="section">
        <h3>Teacher Timetable</h3>
        <div id="teacherGrid"></div>
    </div>

	<script>
    let cachedData = null;

    function timesFromSchedule(info) {
        const set = new Set();
        const order = [];
        Object.values(info.schedule).forEach(rows => {
            (rows || []).forEach(r => {
                const t = r.time; // e.g., 08:00-09:00
                if (t && !set.has(t)) { set.add(t); order.push(t); }
            });
        });
        // Sort by start time
        return order.sort((a,b) => a.localeCompare(b));
    }

    function renderStudentTable(className) {
        const container = document.getElementById('studentGrid');
        container.innerHTML = '';
        if (!cachedData) return;
        const classes = cachedData.classes || {};
        const info = classes[className];
        if (!info) { container.textContent = 'Class not found'; return; }
        const days = Object.keys(info.schedule);
        const times = timesFromSchedule(info);
        const table = document.createElement('table');
        table.className = 'grid';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>Day / Time</th>${times.map(t=>`<th>${t}</th>`).join('')}</tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        days.forEach(day => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><b>${day}</b></td>`;
            const rows = info.schedule[day] || [];
            const map = Object.fromEntries(rows.map(r => [r.time, r]));
            times.forEach(t => {
                const r = map[t];
                if (!r) { tr.innerHTML += '<td></td>'; return; }
                const subj = r.subject;
                const isActivity = r.teacher === 'Activity';
                const isLunch = subj === 'Lunch Break' || r.type === 'Special Period';
                const text = isLunch ? 'Lunch Break' : (subj || '');
                const td = document.createElement('td');
                td.textContent = text;
                if (isActivity) td.style.background = '#f9fff0';
                if (isLunch) td.style.background = '#ffe8cc';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    async function renderTeacherTable(teacherId) {
        const container = document.getElementById('teacherGrid');
        container.innerHTML = '';
        if (!teacherId) { container.textContent = 'Enter a teacher ID'; return; }
        const res = await fetch('/api/teachers/' + encodeURIComponent(teacherId));
        const json = await res.json();
        const rows = (json.data || []).filter(r => r.Day);
        // Collect unique times (normalize removing spaces around '-')
        const normalizeTime = s => (s || '').replace(/\s+/g,''); // 08:00-09:00
        const timesSet = new Set();
        rows.forEach(r => timesSet.add(normalizeTime(r.Time)));
        const times = Array.from(timesSet).sort((a,b)=>a.localeCompare(b));
        const daysSet = new Set(rows.map(r => r.Day));
        const days = Array.from(daysSet);
        const byDayTime = {};
        rows.forEach(r => {
            const day = r.Day;
            const time = normalizeTime(r.Time);
            byDayTime[day] = byDayTime[day] || {};
            byDayTime[day][time] = r.Status === 'Teaching' ? (r.Class || '') : '';
        });
        const table = document.createElement('table');
        table.className = 'grid';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>Day / Time</th>${times.map(t=>`<th>${t}</th>`).join('')}</tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        days.forEach(day => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><b>${day}</b></td>`;
            times.forEach(t => {
                const td = document.createElement('td');
                td.textContent = (byDayTime[day] && byDayTime[day][t]) ? byDayTime[day][t] : '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    async function generateAll() {
        const res = await fetch('/api/generate');
        cachedData = await res.json();
        const classId = document.getElementById('classId').value.trim();
        if (classId) renderStudentTable(classId);
    }
	async function loadClass() {
		const id = document.getElementById('classId').value.trim();
		if (!id) return;
		const res = await fetch('/api/classes/' + encodeURIComponent(id));
		const json = await res.json();
		const tbody = document.getElementById('classOut');
		tbody.innerHTML = '';
		(json.data || []).forEach(row => {
			if (!row.Day) return; // skip empty separators
			const tr = document.createElement('tr');
			tr.innerHTML = `<td>${row.Day}</td><td>${row.Time}</td><td>${row.Subject}</td><td>${row.Teacher}</td><td>${row.Room}</td>`;
			tbody.appendChild(tr);
		});
	}
	async function loadTeacher() {
		const id = document.getElementById('teacherId').value.trim();
		if (!id) return;
		const res = await fetch('/api/teachers/' + encodeURIComponent(id));
		const json = await res.json();
		const tbody = document.getElementById('teacherOut');
		tbody.innerHTML = '';
		(json.data || []).forEach(row => {
			if (!row.Day) return;
			const tr = document.createElement('tr');
			tr.innerHTML = `<td>${row.Day}</td><td>${row.Time}</td><td>${row.Class}</td><td>${row.Subject}</td><td>${row.Room}</td><td>${row.Status}</td>`;
			tbody.appendChild(tr);
		});
	}
    document.getElementById('generate').addEventListener('click', generateAll);
    document.getElementById('showStudent').addEventListener('click', () => {
        if (!cachedData) { generateAll(); return; }
        const classId = document.getElementById('classId').value.trim();
        renderStudentTable(classId);
    });
    document.getElementById('showTeacher').addEventListener('click', () => {
        const teacherId = document.getElementById('teacherId').value.trim();
        renderTeacherTable(teacherId);
    });
	</script>
</body>
</html>
